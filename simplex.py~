import ast, getopt, sys, copy
from latex import build_pdf

class SimplexSolver():

    def __init__(self):
        self.A = []
        self.b = []
        self.c = []

    def set_simplex_input(self, A, b, c):
        ''' Set initial variables here
        '''
        self.A = A
        self.b = b
        self.c = c

    def add_slack_variables(self):
        ''' Add slack variables to matrix A to transform
            inequalities to equalities.
        '''
        slack_vars = self._generate_identity(len(self.A))
        for i in range(0, len(slack_vars)):
            A[i] += slack_vars[i]
            A[i] += [b[i]]

    def create_tableau(self):
        self.add_slack_variables()
        A.append(c + [0] * (len(c)+1))

    def find_pivot(self):
        pass

    def get_Ab(self):
        matrix = copy.deepcopy(A)
        for i in range(0, len(matrix)):
            matrix[i] += [b[i]]
        return matrix
            
    def _generate_identity(self, n):
        ''' Helper function for generating a square identity matrix.
        '''
        I = []
        for i in range(0, n):
            row = []
            for j in range(0, n):
                if i == j:
                    row.append(1)
                else:
                    row.append(0)
            I.append(row)
        return I

    def _str_matrix(self, M):
        ''' Generate string representation of some matrix M.
        '''
        str_mat = ""
        for row in M:
            str_mat += '| '
            if isinstance(row, list):
                for element in row:
                    str_mat += str(element) + ' '
            else:
                str_mat += str(row) + ' '
            str_mat += '|\n'                
        return str_mat

if __name__ == '__main__':

    ''' COMMAND LINE INPUT HANDLING '''
    A = []
    b = []
    c = []
    argv = sys.argv[1:]    
    try:
        opts, args = getopt.getopt(argv,"hA:b:c:",["A=","b=","c="])
    except getopt.GetoptError:
        print('simplex.py -A <matrix> -b <vector> -c <vector>')
        sys.exit(2)
    for opt, arg in opts:
        if opt == '-h':
            print('simplex.py -A <matrix> -b <vector> -c <vector>')
            print('A: An mxn linear system. i.e. "[[1,0],[0,1]]"')
            print('b: Vector. Ax <= b')
            print('c: Vector. Coefficients of objective function.')
            sys.exit()
        elif opt in ("-A"):
            A = ast.literal_eval(arg)
        elif opt in ("-b"):
            b = ast.literal_eval(arg)
        elif opt in ("-c"):
            c = ast.literal_eval(arg)
    if not A or not b or not c:
        print('Must provide arguments for A, b, c (use -h for more info)')
        sys.exit()
    ''' END OF COMMAND LINE INPUT HANDLING '''

    ss = SimplexSolver()
    ss.set_simplex_input(A, b, c)
    latex_str = (r"\documentclass{article}")

    def obj_func(latex_str, c):
        latex_str += (r"\begin{equation}")
        func = ""
        found_value = False
        for index, x in enumerate(c):
            opp = '+'
            if x == 0:
                continue
            if x < 0:
                opp = ' - '
            elif index == 0 or not found_value:
                opp = ''
            if x == 1 or x == -1:
                x = ''
            func += (r"%s %sx_%s "  % (opp, str(x), str(index)))
            found_value = True
        latex_str += (r"\max{%s}" % func)
        latex_str += (r"\end{equation}")
        return latex_str
    
    def eq_from_mat(latex_str, A):
        latex_str += (r"\[")
        latex_str += (r"\left\{")
        latex_str += (r"\begin{array}{c}")
        for i in range(0, len(A)):
            found_value = False
            for index, x in enumerate(A[i]):
                opp = '+'
                if x == 0:
                    continue
                if x < 0:
                    opp = '-'
                elif index == 0 or not found_value:
                    opp = ''
                if index != len(A[i]) - 1:
                    if x == 1 or x == -1:
                        x = ''
                    latex_str += (r"%s %sx_%s "  % (opp, str(x), str(index)))
                else:
                    latex_str += (r"= %s"  % str(x))
                found_value = True
                if (index == len(A[i]) - 1):
                    latex_str += r" \\ "        
        latex_str += (r"\end{array}")
        latex_str += (r"\right.")
        latex_str += (r"\]")
        return latex_str
        
    latex_str += (r"\begin{document}")
    latex_str += (r"\title{Simplex Solver}")
    latex_str += (r"\maketitle")
    latex_str += (r"\begin{flushleft}")
    latex_str += (r"\textbf{Problem}")
    latex_str += (r"\end{flushleft}")
    latex_str += (r"\begin{flushleft}")
    latex_str += (r"Given the following linear system and objective function, "
                  r"find the optimal solution.")
    latex_str += (r"\end{flushleft}")
    latex_str = obj_func(latex_str, ss.c)
    latex_str = eq_from_mat(latex_str, ss.get_Ab())

    latex_str += (r"\begin{flushleft}")
    latex_str += (r"\textbf{Solution}")
    latex_str += (r"\end{flushleft}")
    
    ss.create_tableau()
    #print("2. Create Simplex Tableau")
    #print(ss._str_matrix(ss.A))

    latex_str += (r"\end{document}")
    pdf = build_pdf(latex_str)
    pdf.save_to('solution.pdf')
